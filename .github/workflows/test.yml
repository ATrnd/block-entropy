name: 🧪 Tests & Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  FOUNDRY_PROFILE: default

jobs:
  build-and-test:
    name: 🔨 Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: ⚙️ Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.1.0

      - name: 📋 Show Foundry version
        run: forge --version

      - name: 🏗️ Build contracts
        run: forge build --sizes

      - name: 🧪 Run tests
        run: forge test -vvv

      - name: 📊 Generate gas report
        run: forge test --gas-report > gas-report.txt

      - name: 📤 Upload gas report
        uses: actions/upload-artifact@v4
        with:
          name: gas-report
          path: gas-report.txt

  coverage:
    name: 📈 Coverage Analysis
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: ⚙️ Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.1.0

      - name: 📊 Generate coverage report
        run: forge coverage --report lcov --ir-minimum

      - name: 📤 Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./lcov.info
          fail_ci_if_error: false
          verbose: true

  format-check:
    name: 🎨 Format Check
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v5

      - name: ⚙️ Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.1.0

      - name: 🎨 Check formatting
        run: forge fmt --check

  size-check:
    name: 📏 Contract Size Check
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: ⚙️ Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.1.0

      - name: 📏 Check contract sizes
        run: |
          forge build --sizes | tee contract-sizes.txt
          # Check if any contract exceeds 24KB (Ethereum limit)
          if grep -q "24\.[0-9]" contract-sizes.txt || grep -q "2[5-9]\." contract-sizes.txt || grep -q "[3-9][0-9]\." contract-sizes.txt; then
            echo "❌ Contract size exceeds 24KB limit!"
            exit 1
          else
            echo "✅ All contracts under size limit"
          fi
