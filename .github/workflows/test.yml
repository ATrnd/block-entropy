name: ğŸ§ª Tests & Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  FOUNDRY_PROFILE: default

jobs:
  build-and-test:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: âš™ï¸ Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.1.0

      - name: ğŸ“‹ Show Foundry version
        run: forge --version

      - name: ğŸ—ï¸ Build contracts
        run: forge build --sizes

      - name: ğŸ§ª Run tests
        run: forge test -vvv

      - name: ğŸ“Š Generate gas report
        run: forge test --gas-report > gas-report.txt

      - name: ğŸ“¤ Upload gas report
        uses: actions/upload-artifact@v4
        with:
          name: gas-report
          path: gas-report.txt

  coverage:
    name: ğŸ“ˆ Coverage Analysis
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: âš™ï¸ Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.1.0

      - name: ğŸ“Š Generate coverage report
        run: forge coverage --report lcov --ir-minimum

      - name: ğŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./lcov.info
          fail_ci_if_error: false
          verbose: true

  format-check:
    name: ğŸ¨ Format Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v5

      - name: âš™ï¸ Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.1.0

      - name: ğŸ¨ Check formatting
        run: forge fmt --check

  size-check:
    name: ğŸ“ Contract Size Check
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: âš™ï¸ Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: v1.1.0

      - name: ğŸ“ Check contract sizes
        run: |
          forge build --sizes | tee contract-sizes.txt
          # Check if any contract exceeds 24KB (Ethereum limit)
          if grep -q "24\.[0-9]" contract-sizes.txt || grep -q "2[5-9]\." contract-sizes.txt || grep -q "[3-9][0-9]\." contract-sizes.txt; then
            echo "âŒ Contract size exceeds 24KB limit!"
            exit 1
          else
            echo "âœ… All contracts under size limit"
          fi
